sudo: false

language: java

matrix:
  include:
    - name: "Oracle JDK 8"
      jdk: oraclejdk8
    - name: "OpenJDK 10"
      jdk: openjdk10
      # Fix SSL errors, snippet from https://github.com/travis-ci/travis-ci/issues/9368
      before_install:
        - unset _JAVA_OPTIONS
        - rm "${JAVA_HOME}/lib/security/cacerts"
        - ln -s /etc/ssl/certs/java/cacerts "${JAVA_HOME}/lib/security/cacerts"
    - name: "Local rebuild"
      jdk: oraclejdk8
      script: 
        - ./gradlew --no-daemon -Dmaven.repo.local=maven/target/m2 :biz.aQute.bnd.gradle:build :biz.aQute.bnd.gradle:release
        - ./gradlew --no-daemon -Dmaven.repo.local=maven/target/m2 --rerun-tasks -Pbnd_repourl=./dist/bundles :buildscriptDependencies :build

before_install:
  - unset _JAVA_OPTIONS

install:
  - rvm --version
  - rvm use 2.4 --install --binary --fuzzy
  - ./gradlew --no-daemon --version
  - ./mvnw --version
  - ruby --version
  - gem --version
  - bundle --version

script:
  - ./gradlew --no-daemon -Dmaven.repo.local=maven/target/m2 --continue :build :maven:deploy
  - (cd docs && ./build.sh)

before_cache:
  - git status
  - rm -rf maven/target/m2/biz/aQute/bnd/
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -rf $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.m2/wrapper/
    - cnf/cache/stable/
    - docs/bundler/
    - maven/target/m2/
