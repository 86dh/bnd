/*
 * dist Gradle build script
 */

import aQute.bnd.gradle.Index

def buildProject = project

/* Configure the workspace project */
configure(parent) {
  buildDir = buildProject.buildDir

  task build {
    dependsOn buildProject.absoluteProjectPath('jarDependencies')
    dependsOn buildProject.absoluteProjectPath('checkDependencies')
    dependsOn buildProject.absoluteProjectPath('releaseNeeded')
    description "Assembles, tests and releases the ${buildProject.name} project."
    group 'build'
  }
  defaultTasks = [build.path]
}

checkDependencies {
  mustRunAfter jarDependencies
}

releaseDependencies {
  mustRunAfter jarDependencies, checkDependencies
}

/* Configure this project */
File releaserepo = file(bnd('releaserepo', 'bundles')) /* Release repository. */

task('index', type: Index) {
  description 'Index the release repository.'
  group 'release'
  mustRunAfter releaseDependencies
  repositoryName = "Bnd/Bndtools ${version}"
  base = new File(releaserepo, "${bnd('-groupid').replace('.','/')}/artifact/version")
  gzip = false
  bundles fileTree(releaserepo) {
    include '**/*.jar'
    exclude '**/*-sources.jar'
    exclude '**/*-javadoc.jar'
  }
}

jar {
  inputs.files index
}

clean {
  delete releaserepo
}
