/*
 * dist Gradle build script
 */

import aQute.bnd.gradle.Index

def buildProject = project

/* Configure the workspace project */
configure(parent) {
  buildDir = buildProject.buildDir

  task build {
    dependsOn buildProject.absoluteProjectPath('jarDependencies')
    dependsOn buildProject.absoluteProjectPath('checkDependencies')
    dependsOn buildProject.absoluteProjectPath('releaseNeeded')
    description "Assembles, tests and releases the ${buildProject.name} project."
    group 'build'
  }
  defaultTasks = [build.path]
}

checkDependencies {
  mustRunAfter jarDependencies
}

releaseDependencies {
  mustRunAfter jarDependencies, checkDependencies
}

/* Configure this project */
File releaserepo = file(bnd('releaserepo', 'bundles')) /* Release repository. */

task('indexonly', type: Index) {
  description 'Index the release repository only. (Does not depend on releaseNeeded).'
  group 'release'
  repositoryName = "Bnd/Bndtools ${version}"
  destinationDir = releaserepo
  gzip = true
  bundles fileTree(destinationDir) {
    include '**/*.jar'
    exclude '**/*-latest.jar'
    exclude '**/*-sources.jar'
    exclude '**/*-javadoc.jar'
  }
}

task('index') {
  description 'Index the release repository.'
  group 'release'
  dependsOn releaseDependencies
  finalizedBy indexonly
}

jar {
  dependsOn index
  mustRunAfter indexonly
}

clean {
  delete releaserepo
}
